# version-changelog.yml
name: "Version Changelog"
on:
  push:
    tags:
      - 'v*'

jobs:
  version-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Ensure Unreleased Section Exists
        run: |
          # Add "## Unreleased" at the top ONLY if it doesn't exist, with no extra spaces
          if ! grep -q "^## Unreleased$" CHANGELOG.md; then
            echo -e "## Unreleased\n" > tmp_changelog
            cat CHANGELOG.md >> tmp_changelog
            mv tmp_changelog CHANGELOG.md
          fi

      - name: Move Unreleased to Version
        run: |
          # Replace "## Unreleased" with the new version and date, cleanly add a new Unreleased section
          VERSION="${GITHUB_REF#refs/tags/}"
          DATE=$(date +%Y-%m-%d)
          
          awk -v version="## [$VERSION] - $DATE" '
          /^## Unreleased$/ {print version; print ""; next} 
          1
          ' CHANGELOG.md > tmp && mv tmp CHANGELOG.md

          # Insert "## Unreleased" again at the top cleanly
          sed -i "1i## Unreleased\n" CHANGELOG.md

      - name: Commit updated CHANGELOG
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: develop
          commit_message: "docs: update CHANGELOG.md for version ${{ github.ref_name }}"
          file_pattern: CHANGELOG.md